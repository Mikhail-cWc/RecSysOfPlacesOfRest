version: '3.8'

services:
  postgres:
    image: postgis/postgis:15-3.3
    container_name: places_db
    env_file:
      - .env
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-places_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-places_password}
      POSTGRES_DB: ${POSTGRES_DB:-places_db}
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/schema_postgres.sql:/docker-entrypoint-initdb.d/01-schema.sql
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-places_user} -d ${POSTGRES_DB:-places_db}" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - places_network

  qdrant:
    image: qdrant/qdrant:v1.7.4
    container_name: places_qdrant
    env_file:
      - .env
    ports:
      - "${QDRANT_PORT:-6333}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant_data:/qdrant/storage
    restart: unless-stopped
    networks:
      - places_network

  redis:
    image: redis:7-alpine
    container_name: places_redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - places_network

  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: places_phoenix
    ports:
      - "6006:6006"
    environment:
      - PHOENIX_WORKING_DIR=/phoenix
    volumes:
      - phoenix_data:/phoenix
    restart: unless-stopped
    networks:
      - places_network

  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    container_name: places_backend
    env_file:
      - .env
    environment:
      POSTGRES_HOST: "postgres"
      POSTGRES_PORT: "5432"
      QDRANT_HOST: "qdrant"
      QDRANT_PORT: "6333"
      REDIS_HOST: "redis"
      REDIS_PORT: "6379"
      PHOENIX_ENABLED: "${PHOENIX_ENABLED:-true}"
      PHOENIX_ENDPOINT: "${PHOENIX_ENDPOINT:-http://phoenix:6006/v1/traces}"
      PHOENIX_PROJECT_NAME: "${PHOENIX_PROJECT_NAME:-places-recommendation-agent}"
      OPENAI_EMBEDDING_BASE_URL: "${OPENAI_EMBEDDING_BASE_URL:-https://openrouter.ai/api/v1}"
      OPENAI_EMBEDDING_MODEL: "${OPENAI_EMBEDDING_MODEL:-text-embedding-bge-m3}"
      OPENAI_EMBEDDING_DIM: "${OPENAI_EMBEDDING_DIM:-1024}"
      OPENAI_MODEL: "${OPENAI_MODEL:-google/gemini-2.5-flash}"
      OPENAI_API_KEY: "${OPENAI_API_KEY:-your_openai_api_key_here}" # CHANGE ME
      TELEGRAM_BOT_TOKEN: "${TELEGRAM_BOT_TOKEN:-your_telegram_bot_token_here}" # CHANGE ME
      API_HOST: "${API_HOST:-0.0.0.0}"
      API_PORT: "${API_PORT:-8000}"
    ports:
      - "${API_PORT:-8000}:8000"
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/api/health').read()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      qdrant:
        condition: service_started
    restart: unless-stopped
    networks:
      - places_network

  telegram_bot:
    build:
      context: .
      dockerfile: Dockerfile.bot
    container_name: places_telegram_bot
    env_file:
      - .env
    environment:
      API_BASE_URL: "${API_BASE_URL:-http://backend:8000}"
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - places_network

volumes:
  postgres_data:
    driver: local
  qdrant_data:
    driver: local
  redis_data:
    driver: local
  phoenix_data:
    driver: local

networks:
  places_network:
    driver: bridge
